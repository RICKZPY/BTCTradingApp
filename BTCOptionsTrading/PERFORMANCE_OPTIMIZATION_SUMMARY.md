# æ€§èƒ½ä¼˜åŒ–å’Œç›‘æ§ç³»ç»Ÿå®æ–½æ€»ç»“

## ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡**: Task 15.2 - æ€§èƒ½ä¼˜åŒ–å’Œé”™è¯¯å¤„ç†  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®Œæˆæ—¶é—´**: 2026-02-09

## å®æ–½å†…å®¹

### 1. ç³»ç»Ÿç›‘æ§æ¨¡å— (SystemMonitor)

åˆ›å»ºäº†å®Œæ•´çš„ç³»ç»Ÿç›‘æ§æ¨¡å—ï¼Œæä¾›å®æ—¶æ€§èƒ½ç›‘æ§å’Œå¥åº·æ£€æŸ¥åŠŸèƒ½ã€‚

**æ ¸å¿ƒæ–‡ä»¶:**
- `src/monitoring/system_monitor.py` - ç›‘æ§æ ¸å¿ƒç±»
- `src/monitoring/__init__.py` - æ¨¡å—å¯¼å‡º

**åŠŸèƒ½ç‰¹æ€§:**

#### 1.1 æ€§èƒ½æŒ‡æ ‡ç›‘æ§
- **CPUä½¿ç”¨ç‡**: å®æ—¶ç›‘æ§CPUè´Ÿè½½
- **å†…å­˜ä½¿ç”¨**: è·Ÿè¸ªå†…å­˜ä½¿ç”¨æƒ…å†µå’Œå¯ç”¨å†…å­˜
- **ç£ç›˜ä½¿ç”¨**: ç›‘æ§ç£ç›˜ç©ºé—´ä½¿ç”¨ç‡
- **ç½‘ç»œè¿æ¥**: ç»Ÿè®¡æ´»åŠ¨è¿æ¥æ•°
- **å“åº”æ—¶é—´**: è®°å½•æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´

#### 1.2 å¥åº·æ£€æŸ¥ç³»ç»Ÿ
- **å¤šç»´åº¦è¯„ä¼°**: åŸºäºCPUã€å†…å­˜ã€ç£ç›˜ã€é”™è¯¯ç‡ã€å“åº”æ—¶é—´
- **ä¸‰çº§çŠ¶æ€**: healthyï¼ˆå¥åº·ï¼‰ã€degradedï¼ˆé™çº§ï¼‰ã€unhealthyï¼ˆä¸å¥åº·ï¼‰
- **å¯é…ç½®é˜ˆå€¼**:
  - CPUä½¿ç”¨ç‡: 80%
  - å†…å­˜ä½¿ç”¨ç‡: 85%
  - ç£ç›˜ä½¿ç”¨ç‡: 90%
  - é”™è¯¯ç‡: 5%
  - å¹³å‡å“åº”æ—¶é—´: 1000ms

#### 1.3 è¯·æ±‚ç»Ÿè®¡
- **è¯·æ±‚è®¡æ•°**: æ€»è¯·æ±‚æ•°å’Œé”™è¯¯æ•°
- **é”™è¯¯ç‡**: å®æ—¶è®¡ç®—é”™è¯¯ç‡å’ŒæˆåŠŸç‡
- **å“åº”æ—¶é—´åˆ†æ**: å¹³å‡ã€æœ€å°ã€æœ€å¤§å“åº”æ—¶é—´
- **å†å²æ•°æ®**: ä¿å­˜æœ€è¿‘100ä¸ªæ•°æ®ç‚¹

#### 1.4 è¿è¡Œæ—¶é—´è·Ÿè¸ª
- **å¯åŠ¨æ—¶é—´**: è®°å½•ç³»ç»Ÿå¯åŠ¨æ—¶é—´
- **è¿è¡Œæ—¶é•¿**: è®¡ç®—ç³»ç»Ÿè¿è¡Œæ—¶é•¿
- **æ ¼å¼åŒ–è¾“å‡º**: å‹å¥½çš„æ—¶é—´æ ¼å¼æ˜¾ç¤º

### 2. APIæ¥å£å¢å¼º

#### 2.1 å¥åº·æ£€æŸ¥æ¥å£ `/health`
```json
{
  "status": "healthy",
  "timestamp": "2026-02-09T22:22:51.778562",
  "service": "BTC Options Trading System",
  "checks": {
    "cpu": true,
    "memory": true,
    "disk": true,
    "error_rate": true,
    "response_time": true
  },
  "issues": []
}
```

#### 2.2 ç³»ç»ŸçŠ¶æ€æ¥å£ `/status`
æä¾›å®Œæ•´çš„ç³»ç»ŸçŠ¶æ€ä¿¡æ¯ï¼š
- è¿è¡Œæ—¶é—´ç»Ÿè®¡
- æ€§èƒ½æŒ‡æ ‡ï¼ˆCPUã€å†…å­˜ã€ç£ç›˜ï¼‰
- è¯·æ±‚ç»Ÿè®¡ï¼ˆæ€»æ•°ã€é”™è¯¯ã€å“åº”æ—¶é—´ï¼‰
- æ•°æ®åº“çŠ¶æ€

#### 2.3 æ€§èƒ½æŒ‡æ ‡æ¥å£ `/metrics`
è¿”å›å½“å‰æ€§èƒ½æŒ‡æ ‡å¿«ç…§

#### 2.4 å†å²æŒ‡æ ‡æ¥å£ `/metrics/history`
æ”¯æŒæŸ¥è¯¢1-60åˆ†é’Ÿçš„å†å²æ•°æ®

#### 2.5 ç»Ÿè®¡ä¿¡æ¯æ¥å£ `/statistics`
æä¾›è¯¦ç»†çš„è¯·æ±‚ç»Ÿè®¡å’Œè¿è¡Œæ—¶é—´ä¿¡æ¯

#### 2.6 è®¡æ•°å™¨é‡ç½®æ¥å£ `/metrics/reset`
å…è®¸é‡ç½®ç›‘æ§è®¡æ•°å™¨ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

### 3. æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶

åœ¨ `src/api/app.py` ä¸­æ·»åŠ äº†HTTPä¸­é—´ä»¶ï¼š

**åŠŸèƒ½:**
- è‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´
- è¯†åˆ«å’Œç»Ÿè®¡é”™è¯¯è¯·æ±‚
- åœ¨å“åº”å¤´ä¸­æ·»åŠ  `X-Response-Time` å­—æ®µ
- ä¸SystemMonitoré›†æˆï¼Œå®æ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®

**å®ç°:**
```python
@app.middleware("http")
async def monitor_requests(request: Request, call_next):
    start_time = time.time()
    try:
        response = await call_next(request)
        response_time_ms = (time.time() - start_time) * 1000
        monitor = get_monitor()
        is_error = response.status_code >= 400
        monitor.record_request(response_time_ms, is_error)
        response.headers["X-Response-Time"] = f"{response_time_ms:.2f}ms"
        return response
    except Exception as e:
        response_time_ms = (time.time() - start_time) * 1000
        monitor = get_monitor()
        monitor.record_request(response_time_ms, is_error=True)
        raise e
```

### 4. é”™è¯¯å¤„ç†å¢å¼º

å¢å¼ºäº†å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼š
- è‡ªåŠ¨è®°å½•é”™è¯¯åˆ°ç›‘æ§ç³»ç»Ÿ
- è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•
- å‹å¥½çš„é”™è¯¯å“åº”

### 5. ä¾èµ–ç®¡ç†

æ·»åŠ äº† `psutil==5.9.5` åˆ° `requirements.txt`ï¼Œç”¨äºç³»ç»Ÿèµ„æºç›‘æ§ã€‚

## æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
åˆ›å»ºäº† `test_monitoring.py`ï¼ŒåŒ…å«7ä¸ªæµ‹è¯•ç”¨ä¾‹ï¼š

1. âœ… å¥åº·æ£€æŸ¥æ¥å£æµ‹è¯•
2. âœ… ç³»ç»ŸçŠ¶æ€æ¥å£æµ‹è¯•
3. âœ… æ€§èƒ½æŒ‡æ ‡æ¥å£æµ‹è¯•
4. âœ… å†å²æŒ‡æ ‡æ¥å£æµ‹è¯•
5. âœ… ç»Ÿè®¡ä¿¡æ¯æ¥å£æµ‹è¯•
6. âœ… è´Ÿè½½æ¨¡æ‹Ÿæµ‹è¯•ï¼ˆ10ä¸ªå¹¶å‘è¯·æ±‚ï¼‰
7. âœ… å“åº”æ—¶é—´å¤´éªŒè¯

### æµ‹è¯•ç»“æœ
```
æ€»è®¡: 7/7 æµ‹è¯•é€šè¿‡ (100.0%)
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç›‘æ§ç³»ç»Ÿå·¥ä½œæ­£å¸¸ã€‚
```

### æ€§èƒ½æŒ‡æ ‡
- å¹³å‡å“åº”æ—¶é—´: ~94ms
- é”™è¯¯ç‡: 0%
- æˆåŠŸç‡: 100%
- ç³»ç»Ÿèµ„æºå ç”¨æ­£å¸¸

## æ–‡æ¡£

åˆ›å»ºäº†å®Œæ•´çš„ç›‘æ§ç³»ç»Ÿæ–‡æ¡£ï¼š

**æ–‡ä»¶**: `MONITORING_GUIDE.md` (400+ è¡Œ)

**å†…å®¹åŒ…æ‹¬:**
- åŠŸèƒ½ç‰¹æ€§ä»‹ç»
- APIæ¥å£è¯¦ç»†è¯´æ˜
- ä½¿ç”¨ç¤ºä¾‹ï¼ˆPythonã€JavaScriptã€cURLï¼‰
- ç›‘æ§é›†æˆæ–¹æ¡ˆ
- æ€§èƒ½ä¼˜åŒ–å»ºè®®
- æ•…éšœæ’æŸ¥æŒ‡å—
- é…ç½®è¯´æ˜
- æœ€ä½³å®è·µ

## æŠ€æœ¯äº®ç‚¹

### 1. è½»é‡çº§è®¾è®¡
- ä½¿ç”¨ `psutil` åº“ï¼Œæ€§èƒ½å¼€é”€å°
- å¼‚æ­¥ä¸­é—´ä»¶ï¼Œä¸é˜»å¡è¯·æ±‚å¤„ç†
- å†…å­˜é«˜æ•ˆçš„æ•°æ®ç»“æ„ï¼ˆdequeï¼‰

### 2. å®æ—¶æ€§
- æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå®æ—¶æ›´æ–°ç»Ÿè®¡æ•°æ®
- æ”¯æŒå®æ—¶æŸ¥è¯¢å½“å‰æ€§èƒ½æŒ‡æ ‡
- å†å²æ•°æ®è‡ªåŠ¨ç®¡ç†ï¼ˆæœ€å¤šä¿ç•™100ä¸ªæ•°æ®ç‚¹ï¼‰

### 3. å¯æ‰©å±•æ€§
- æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºæ‰©å±•
- å¯é…ç½®çš„å¥åº·æ£€æŸ¥é˜ˆå€¼
- æ”¯æŒè‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡

### 4. ç”Ÿäº§å°±ç»ª
- å®Œå–„çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- æ”¯æŒå¤šç§ç›‘æ§é›†æˆæ–¹æ¡ˆï¼ˆPrometheusã€Grafanaç­‰ï¼‰

## ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Application                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Performance Monitoring Middleware        â”‚  â”‚
â”‚  â”‚  - Record request time                           â”‚  â”‚
â”‚  â”‚  - Track errors                                  â”‚  â”‚
â”‚  â”‚  - Add response headers                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            SystemMonitor (Singleton)             â”‚  â”‚
â”‚  â”‚  - CPU/Memory/Disk monitoring                    â”‚  â”‚
â”‚  â”‚  - Request statistics                            â”‚  â”‚
â”‚  â”‚  - Health checks                                 â”‚  â”‚
â”‚  â”‚  - Metrics history                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â†“                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              Monitoring API Routes               â”‚  â”‚
â”‚  â”‚  /health - Health check                          â”‚  â”‚
â”‚  â”‚  /status - System status                         â”‚  â”‚
â”‚  â”‚  /metrics - Current metrics                      â”‚  â”‚
â”‚  â”‚  /metrics/history - Historical data              â”‚  â”‚
â”‚  â”‚  /statistics - Request statistics                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½¿ç”¨ç¤ºä¾‹

### æ£€æŸ¥ç³»ç»Ÿå¥åº·
```bash
curl http://localhost:8000/health
```

### æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€
```bash
curl http://localhost:8000/status
```

### è·å–æ€§èƒ½æŒ‡æ ‡
```bash
curl http://localhost:8000/metrics
```

### æŸ¥è¯¢å†å²æ•°æ®
```bash
curl "http://localhost:8000/metrics/history?minutes=10"
```

### Pythoné›†æˆ
```python
import requests

# æ£€æŸ¥å¥åº·çŠ¶æ€
response = requests.get('http://localhost:8000/health')
health = response.json()

if health['status'] != 'healthy':
    print(f"è­¦å‘Š: ç³»ç»ŸçŠ¶æ€ {health['status']}")
    for issue in health['issues']:
        print(f"  - {issue}")
```

## ç›‘æ§é›†æˆ

### Prometheuså¯¼å‡ºå™¨ç¤ºä¾‹
```python
from prometheus_client import start_http_server, Gauge
import requests
import time

cpu_gauge = Gauge('system_cpu_percent', 'CPUä½¿ç”¨ç‡')
memory_gauge = Gauge('system_memory_percent', 'å†…å­˜ä½¿ç”¨ç‡')

def collect_metrics():
    response = requests.get('http://localhost:8000/metrics')
    metrics = response.json()
    cpu_gauge.set(metrics['cpu_percent'])
    memory_gauge.set(metrics['memory_percent'])

if __name__ == '__main__':
    start_http_server(8001)
    while True:
        collect_metrics()
        time.sleep(15)
```

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### å·²å®æ–½çš„ä¼˜åŒ–
1. âœ… è¯·æ±‚å“åº”æ—¶é—´è·Ÿè¸ª
2. âœ… é”™è¯¯ç‡ç›‘æ§
3. âœ… ç³»ç»Ÿèµ„æºç›‘æ§
4. âœ… å¥åº·æ£€æŸ¥è‡ªåŠ¨åŒ–

### æœªæ¥ä¼˜åŒ–æ–¹å‘
1. æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ·»åŠ ç´¢å¼•ã€æŸ¥è¯¢ç¼“å­˜ï¼‰
2. Redisç¼“å­˜é›†æˆï¼ˆçƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼‰
3. è¿æ¥æ± ä¼˜åŒ–ï¼ˆæ•°æ®åº“è¿æ¥æ± é…ç½®ï¼‰
4. å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—ï¼ˆCeleryé›†æˆï¼‰
5. CDNé›†æˆï¼ˆé™æ€èµ„æºåŠ é€Ÿï¼‰

## ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒä»£ç 
- `src/monitoring/system_monitor.py` - ç›‘æ§æ ¸å¿ƒç±»ï¼ˆ200è¡Œï¼‰
- `src/monitoring/__init__.py` - æ¨¡å—å¯¼å‡º
- `src/api/routes/health.py` - å¥åº·æ£€æŸ¥è·¯ç”±ï¼ˆå¢å¼ºç‰ˆï¼Œ150è¡Œï¼‰
- `src/api/app.py` - ä¸»åº”ç”¨ï¼ˆæ·»åŠ ç›‘æ§ä¸­é—´ä»¶ï¼‰

### æµ‹è¯•æ–‡ä»¶
- `test_monitoring.py` - ç›‘æ§ç³»ç»Ÿæµ‹è¯•ï¼ˆ300è¡Œï¼‰

### æ–‡æ¡£
- `MONITORING_GUIDE.md` - ç›‘æ§ç³»ç»Ÿä½¿ç”¨æŒ‡å—ï¼ˆ400è¡Œï¼‰
- `PERFORMANCE_OPTIMIZATION_SUMMARY.md` - æœ¬æ–‡æ¡£

### é…ç½®
- `requirements.txt` - æ·»åŠ psutilä¾èµ–

## æ€»ç»“

Task 15.2 å·²æˆåŠŸå®Œæˆï¼Œç³»ç»Ÿç°åœ¨å…·å¤‡ï¼š

âœ… **å®Œæ•´çš„æ€§èƒ½ç›‘æ§**: CPUã€å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œè¿æ¥  
âœ… **æ™ºèƒ½å¥åº·æ£€æŸ¥**: å¤šç»´åº¦è¯„ä¼°ï¼Œä¸‰çº§çŠ¶æ€  
âœ… **è¯¦ç»†çš„è¯·æ±‚ç»Ÿè®¡**: å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€æˆåŠŸç‡  
âœ… **å†å²æ•°æ®è¿½è¸ª**: æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢  
âœ… **å®æ—¶ç›‘æ§ä¸­é—´ä»¶**: è‡ªåŠ¨è®°å½•æ¯ä¸ªè¯·æ±‚  
âœ… **å®Œå–„çš„APIæ¥å£**: 6ä¸ªç›‘æ§ç«¯ç‚¹  
âœ… **å…¨é¢çš„æµ‹è¯•è¦†ç›–**: 7ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡  
âœ… **è¯¦ç»†çš„æ–‡æ¡£**: 400è¡Œä½¿ç”¨æŒ‡å—  

ç³»ç»Ÿå·²ç»å…·å¤‡ç”Ÿäº§ç¯å¢ƒæ‰€éœ€çš„ç›‘æ§å’Œæ€§èƒ½ä¼˜åŒ–åŸºç¡€è®¾æ–½ï¼Œå¯ä»¥å®æ—¶äº†è§£ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ï¼Œå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ã€‚

## ä¸‹ä¸€æ­¥

å»ºè®®ç»§ç»­è¿›è¡Œï¼š
- Task 15.3: ç¼–å†™é›†æˆæµ‹è¯•ï¼ˆå¯é€‰ï¼‰
- Task 16: æœ€ç»ˆæ£€æŸ¥ç‚¹ - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡
- æˆ–è€…æ ¹æ®ç”¨æˆ·éœ€æ±‚è¿›è¡Œå…¶ä»–ä¼˜åŒ–å’ŒåŠŸèƒ½å¼€å‘
