# 回测功能说明

## 📊 当前状态

### ⚠️ 重要提示

**系统当前使用模拟数据进行回测，不是真实历史数据！**

### 为什么使用模拟数据？

1. **API未配置** - 需要Deribit API密钥才能获取真实数据
2. **回测引擎简化** - 当前使用固定价格和理论模型
3. **开箱即用** - 无需配置即可体验功能

### 模拟数据说明

**期权价格计算**：
- ✅ 使用Black-Scholes模型
- ✅ 基于理论定价公式
- ✅ 包含波动率微笑
- ✅ 希腊字母计算准确

**回测限制**：
- ⚠️ 标的价格固定在$50,000
- ⚠️ 无真实价格波动
- ⚠️ 结果仅供学习参考
- ⚠️ **不能用于实盘决策**

---

## 🚀 快速使用回测

### 方法1: Web界面（推荐）

1. **创建策略**
   - 进入"策略管理"Tab
   - 选择策略类型（如Long Call）
   - 设置参数并保存

2. **运行回测**
   - 进入"回测分析"Tab
   - 选择策略
   - 设置日期和初始资金
   - 点击"运行回测"

3. **查看结果**
   - 盈亏曲线图
   - 绩效指标（收益率、夏普比率、最大回撤）
   - 交易明细

### 方法2: Python脚本

```python
from datetime import datetime, timedelta
from decimal import Decimal
from src.backtest.backtest_engine import BacktestEngine
from src.strategy.strategy_manager import StrategyManager

# 创建策略
strategy_manager = StrategyManager()
strategy = strategy_manager.create_long_call_strategy(
    underlying_symbol="BTC",
    strike_price=Decimal("50000"),
    expiration_date=datetime.now() + timedelta(days=30),
    quantity=1
)

# 运行回测
engine = BacktestEngine()
result = await engine.run_backtest(
    strategy=strategy,
    start_date=datetime(2024, 1, 1),
    end_date=datetime(2024, 2, 1),
    initial_capital=Decimal("100000")
)

# 查看结果
print(f"总收益率: {result.total_return:.2%}")
print(f"夏普比率: {result.sharpe_ratio:.2f}")
```

---

## 🔧 如何使用真实数据

### 第1步: 获取API密钥

1. 访问 https://test.deribit.com
2. 注册账号
3. 创建API密钥（只需Read权限）

### 第2步: 配置系统

1. 打开 http://localhost:3000
2. 进入"设置"Tab
3. 输入API Key和Secret
4. 点击"保存配置"

### 第3步: 重启服务

```bash
cd BTCOptionsTrading/backend
# Ctrl+C 停止
python run_api.py  # 重启
```

### 第4步: 验证

```bash
cd BTCOptionsTrading/backend
python test_real_data.py
```

看到 ✅ 表示配置成功！

---

## 📈 回测结果解读

### 绩效指标

**总收益率**：
- 计算公式：(最终资金 - 初始资金) / 初始资金
- 示例：+15.3% 表示盈利15.3%

**夏普比率**：
- 衡量风险调整后收益
- > 1.0 较好，> 2.0 优秀
- 考虑了收益的波动性

**最大回撤**：
- 从峰值到谷底的最大跌幅
- 示例：-8.2% 表示最大亏损8.2%
- 越小越好

**胜率**：
- 盈利交易占比
- 示例：65% 表示65%的交易盈利

### 盈亏曲线

**蓝线 - 组合价值**：
- 显示总资产变化
- 包括现金和持仓价值

**绿线 - 累计盈亏**：
- 相对于初始资金的盈亏
- 正值表示盈利，负值表示亏损

---

## ⚠️ 重要警告

### 当前回测的局限性

1. **标的价格固定**
   - 当前：BTC价格固定在$50,000
   - 实际：价格应该每天变化
   - 影响：无法反映真实市场波动

2. **无真实历史数据**
   - 当前：使用理论模型
   - 实际：应使用历史价格数据
   - 影响：回测结果不可靠

3. **简化的市场模型**
   - 当前：不考虑滑点、流动性
   - 实际：真实交易有成本
   - 影响：实盘结果会更差

### 使用建议

✅ **可以用于**：
- 学习期权策略
- 理解希腊字母
- 测试系统功能
- 策略逻辑验证

❌ **不能用于**：
- 实盘交易决策
- 资金管理决策
- 风险评估
- 绩效预测

---

## 🔮 未来改进计划

### 短期（1-2周）

1. **集成真实历史价格**
   - 从Deribit获取历史数据
   - 每日更新标的价格
   - 真实的价格波动

2. **改进期权定价**
   - 使用真实隐含波动率
   - 考虑买卖价差
   - 更准确的希腊字母

### 中期（1个月）

1. **高级回测功能**
   - 滑点模拟
   - 流动性影响
   - 交易成本优化

2. **数据管理**
   - 历史数据缓存
   - 离线回测支持
   - 数据质量检查

### 长期（3个月）

1. **实时监控**
   - WebSocket实时数据
   - 实时组合监控
   - 实时风险计算

2. **策略优化**
   - 参数优化
   - 机器学习集成
   - 自动化交易

---

## 📚 相关文档

- [完整使用指南](./使用指南.md) - 详细的系统使用说明
- [数据来源指南](./DATA_SOURCE_GUIDE.md) - 数据来源详细说明
- [API配置指南](./API_CONFIGURATION_GUIDE.md) - API配置步骤

---

## 💡 常见问题

**Q: 回测结果准确吗？**
A: 当前使用模拟数据，结果仅供学习参考，不能用于实盘决策。

**Q: 如何获得准确的回测？**
A: 需要：1) 配置API获取真实数据 2) 等待回测引擎改进 3) 使用足够长的回测周期

**Q: 测试网数据可靠吗？**
A: 测试网数据是真实的，但可能有延迟。建议先用测试网学习，再考虑主网。

**Q: 需要多少资金才能开始？**
A: 测试网使用虚拟资金，完全免费。主网需要真实资金，建议从小额开始。

---

**总结**：系统功能完整，但当前使用模拟数据。配置API后可获取真实期权数据，但回测引擎还需改进才能用于实盘决策。建议先用于学习和测试。
