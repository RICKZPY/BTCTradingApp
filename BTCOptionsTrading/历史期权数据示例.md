# 历史期权数据示例

## 📊 数据概览

历史期权数据包含期权合约在不同时间点的价格、交易量等信息，用于回测和分析。

---

## 1. CSV原始数据格式

### 文件命名规则

```
Deribit_BTCUSD_20240329_49000_P.csv
│      │      │        │      └─ 期权类型 (P=看跌, C=看涨)
│      │      │        └─────── 执行价格 (49000美元)
│      │      └──────────────── 到期日期 (2024年3月29日)
│      └─────────────────────── 标的资产 (BTCUSD)
└────────────────────────────── 数据来源 (Deribit)
```

### CSV文件内容示例

```csv
unix,open,high,low,close,volume
1711670400,0.0500,0.0550,0.0450,0.0525,100.5
1711674000,0.0525,0.0575,0.0500,0.0550,150.25
1711677600,0.0550,0.0600,0.0525,0.0575,200.75
1711681200,0.0575,0.0625,0.0550,0.0600,175.50
```

**字段说明**：
- `unix`: Unix时间戳（秒）
- `open`: 开盘价（BTC）
- `high`: 最高价（BTC）
- `low`: 最低价（BTC）
- `close`: 收盘价（BTC）
- `volume`: 交易量（合约数）

### 真实数据示例

**BTC-29MAR24-49000-P (看跌期权)**
```
时间: 2024-03-29 00:00:00
开盘: 0.0500 BTC
最高: 0.0550 BTC
最低: 0.0450 BTC
收盘: 0.0525 BTC
交易量: 100.5 合约
```

**BTC-29MAR24-50000-C (看涨期权)**
```
时间: 2024-03-29 00:00:00
开盘: 0.0500 BTC
最高: 0.0550 BTC
最低: 0.0450 BTC
收盘: 0.0525 BTC
交易量: 100.5 合约
```

---

## 2. 数据库存储格式

### 数据表结构

```sql
CREATE TABLE historical_options_data (
    id UUID PRIMARY KEY,
    instrument_name VARCHAR(50) NOT NULL,
    timestamp TIMESTAMP NOT NULL,
    open_price DECIMAL(20, 8) NOT NULL,
    high_price DECIMAL(20, 8) NOT NULL,
    low_price DECIMAL(20, 8) NOT NULL,
    close_price DECIMAL(20, 8) NOT NULL,
    volume DECIMAL(20, 8) NOT NULL,
    strike_price DECIMAL(20, 8) NOT NULL,
    expiry_date TIMESTAMP NOT NULL,
    option_type VARCHAR(10) NOT NULL,
    underlying_symbol VARCHAR(10) NOT NULL,
    data_source VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_instrument_timestamp (instrument_name, timestamp),
    INDEX idx_expiry_strike (expiry_date, strike_price),
    INDEX idx_timestamp (timestamp)
);
```

### 数据库记录示例

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "instrument_name": "BTC-29MAR24-49000-P",
  "timestamp": "2024-03-29T00:00:00Z",
  "open_price": 0.05000000,
  "high_price": 0.05500000,
  "low_price": 0.04500000,
  "close_price": 0.05250000,
  "volume": 100.50000000,
  "strike_price": 49000.00000000,
  "expiry_date": "2024-03-29T08:00:00Z",
  "option_type": "PUT",
  "underlying_symbol": "BTC",
  "data_source": "CryptoDataDownload",
  "created_at": "2024-03-01T10:30:00Z"
}
```

---

## 3. Python数据模型

### HistoricalOptionData 类

```python
@dataclass
class HistoricalOptionData:
    """历史期权数据"""
    instrument_name: str          # 合约名称: "BTC-29MAR24-49000-P"
    timestamp: datetime           # 时间戳
    open_price: Decimal          # 开盘价 (BTC)
    high_price: Decimal          # 最高价 (BTC)
    low_price: Decimal           # 最低价 (BTC)
    close_price: Decimal         # 收盘价 (BTC)
    volume: Decimal              # 交易量
    strike_price: Decimal        # 执行价格 (USD)
    expiry_date: datetime        # 到期日期
    option_type: OptionType      # 期权类型 (CALL/PUT)
    underlying_symbol: str       # 标的资产: "BTC"
    data_source: DataSource      # 数据来源
    id: UUID                     # 唯一标识符
```

### 实例化示例

```python
from datetime import datetime
from decimal import Decimal
from src.historical.models import HistoricalOptionData, DataSource
from src.core.models import OptionType

# 创建历史数据对象
data = HistoricalOptionData(
    instrument_name="BTC-29MAR24-49000-P",
    timestamp=datetime(2024, 3, 29, 0, 0, 0),
    open_price=Decimal("0.0500"),
    high_price=Decimal("0.0550"),
    low_price=Decimal("0.0450"),
    close_price=Decimal("0.0525"),
    volume=Decimal("100.5"),
    strike_price=Decimal("49000"),
    expiry_date=datetime(2024, 3, 29, 8, 0, 0),
    option_type=OptionType.PUT,
    underlying_symbol="BTC",
    data_source=DataSource.CRYPTO_DATA_DOWNLOAD
)

# 访问数据
print(f"合约: {data.instrument_name}")
print(f"收盘价: {data.close_price} BTC")
print(f"中间价: {data.mid_price} BTC")
print(f"价格范围: {data.price_range} BTC")
```

---

## 4. API响应格式

### GET /api/historical/data

**请求示例**：
```http
GET /api/historical/data?instrument=BTC-29MAR24-49000-P&start_date=2024-03-01&end_date=2024-03-31
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "instrument_name": "BTC-29MAR24-49000-P",
      "timestamp": "2024-03-29T00:00:00Z",
      "open_price": 0.0500,
      "high_price": 0.0550,
      "low_price": 0.0450,
      "close_price": 0.0525,
      "volume": 100.5,
      "strike_price": 49000,
      "expiry_date": "2024-03-29T08:00:00Z",
      "option_type": "PUT",
      "underlying_symbol": "BTC"
    },
    {
      "instrument_name": "BTC-29MAR24-49000-P",
      "timestamp": "2024-03-29T01:00:00Z",
      "open_price": 0.0525,
      "high_price": 0.0575,
      "low_price": 0.0500,
      "close_price": 0.0550,
      "volume": 150.25,
      "strike_price": 49000,
      "expiry_date": "2024-03-29T08:00:00Z",
      "option_type": "PUT",
      "underlying_symbol": "BTC"
    }
  ],
  "metadata": {
    "total_records": 2,
    "start_date": "2024-03-01T00:00:00Z",
    "end_date": "2024-03-31T23:59:59Z",
    "instruments": ["BTC-29MAR24-49000-P"]
  }
}
```

---

## 5. 完整数据示例（多个合约）

### 场景：2024年3月29日到期的BTC期权

```
标的资产: BTC
当前价格: $50,000
到期日: 2024-03-29

期权链:
┌─────────────────────────────────────────────────────────────┐
│ 执行价  │  看涨期权 (Call)  │  看跌期权 (Put)              │
├─────────┼───────────────────┼──────────────────────────────┤
│ $48,000 │ BTC-29MAR24-48000-C │ BTC-29MAR24-48000-P        │
│         │ 价格: 0.0800 BTC   │ 价格: 0.0200 BTC           │
│         │ 交易量: 250        │ 交易量: 180                │
├─────────┼───────────────────┼──────────────────────────────┤
│ $49,000 │ BTC-29MAR24-49000-C │ BTC-29MAR24-49000-P        │
│         │ 价格: 0.0600 BTC   │ 价格: 0.0300 BTC           │
│         │ 交易量: 320        │ 交易量: 220                │
├─────────┼───────────────────┼──────────────────────────────┤
│ $50,000 │ BTC-29MAR24-50000-C │ BTC-29MAR24-50000-P (ATM)  │
│         │ 价格: 0.0450 BTC   │ 价格: 0.0450 BTC           │
│         │ 交易量: 500        │ 交易量: 480                │
├─────────┼───────────────────┼──────────────────────────────┤
│ $51,000 │ BTC-29MAR24-51000-C │ BTC-29MAR24-51000-P        │
│         │ 价格: 0.0300 BTC   │ 价格: 0.0600 BTC           │
│         │ 交易量: 280        │ 交易量: 310                │
├─────────┼───────────────────┼──────────────────────────────┤
│ $52,000 │ BTC-29MAR24-52000-C │ BTC-29MAR24-52000-P        │
│         │ 价格: 0.0200 BTC   │ 价格: 0.0800 BTC           │
│         │ 交易量: 190        │ 交易量: 260                │
└─────────┴───────────────────┴──────────────────────────────┘
```

### JSON格式（完整数据集）

```json
{
  "date": "2024-03-29",
  "underlying": "BTC",
  "underlying_price": 50000,
  "expiry": "2024-03-29T08:00:00Z",
  "options": [
    {
      "instrument_name": "BTC-29MAR24-48000-C",
      "strike": 48000,
      "type": "CALL",
      "ohlcv": {
        "timestamp": "2024-03-29T00:00:00Z",
        "open": 0.0780,
        "high": 0.0820,
        "low": 0.0760,
        "close": 0.0800,
        "volume": 250
      }
    },
    {
      "instrument_name": "BTC-29MAR24-48000-P",
      "strike": 48000,
      "type": "PUT",
      "ohlcv": {
        "timestamp": "2024-03-29T00:00:00Z",
        "open": 0.0180,
        "high": 0.0220,
        "low": 0.0180,
        "close": 0.0200,
        "volume": 180
      }
    },
    {
      "instrument_name": "BTC-29MAR24-50000-C",
      "strike": 50000,
      "type": "CALL",
      "ohlcv": {
        "timestamp": "2024-03-29T00:00:00Z",
        "open": 0.0430,
        "high": 0.0470,
        "low": 0.0420,
        "close": 0.0450,
        "volume": 500
      }
    },
    {
      "instrument_name": "BTC-29MAR24-50000-P",
      "strike": 50000,
      "type": "PUT",
      "ohlcv": {
        "timestamp": "2024-03-29T00:00:00Z",
        "open": 0.0430,
        "high": 0.0470,
        "low": 0.0420,
        "close": 0.0450,
        "volume": 480
      }
    }
  ]
}
```

---

## 6. 时间序列数据示例

### 单个期权的24小时价格变化

**BTC-29MAR24-50000-C (平值看涨期权)**

```
时间          开盘    最高    最低    收盘    交易量
00:00:00    0.0450  0.0470  0.0430  0.0460   500
01:00:00    0.0460  0.0480  0.0450  0.0470   520
02:00:00    0.0470  0.0490  0.0460  0.0480   480
03:00:00    0.0480  0.0500  0.0470  0.0490   510
04:00:00    0.0490  0.0510  0.0480  0.0500   530
05:00:00    0.0500  0.0520  0.0490  0.0510   550
06:00:00    0.0510  0.0530  0.0500  0.0520   570
07:00:00    0.0520  0.0540  0.0510  0.0530   590
08:00:00    到期 - 行权价值计算
```

### 价格走势图（ASCII）

```
价格 (BTC)
0.0540 │                                    ╭─╮
0.0530 │                              ╭─────╯ ╰─
0.0520 │                        ╭─────╯
0.0510 │                  ╭─────╯
0.0500 │            ╭─────╯
0.0490 │      ╭─────╯
0.0480 │╭─────╯
0.0470 │╯
0.0460 │
0.0450 │
       └─────────────────────────────────────────
       00:00  02:00  04:00  06:00  08:00  时间
```

---

## 7. 数据质量指标

### 质量报告示例

```json
{
  "quality_report": {
    "total_records": 1000,
    "missing_records": 5,
    "anomaly_records": 2,
    "coverage_percentage": 0.995,
    "time_range": {
      "start": "2024-03-01T00:00:00Z",
      "end": "2024-03-31T23:59:59Z"
    },
    "quality_score": 94.5,
    "issues": [
      {
        "severity": "WARNING",
        "message": "价格跳跃异常: 从 0.0450 跳到 0.0650",
        "timestamp": "2024-03-15T14:30:00Z",
        "record_index": 450
      },
      {
        "severity": "INFO",
        "message": "交易量为0",
        "timestamp": "2024-03-20T03:00:00Z",
        "record_index": 680
      }
    ]
  }
}
```

### 覆盖率统计

```json
{
  "coverage_stats": {
    "start_date": "2024-03-01",
    "end_date": "2024-03-31",
    "total_days": 31,
    "days_with_data": 30,
    "coverage_percentage": 0.968,
    "missing_dates": ["2024-03-15"],
    "strikes_covered": [48000, 49000, 50000, 51000, 52000],
    "expiries_covered": [
      "2024-03-29",
      "2024-04-26",
      "2024-05-31"
    ]
  }
}
```

---

## 8. 回测数据集格式

### BacktestDataSet 结构

```python
@dataclass
class BacktestDataSet:
    """回测数据集"""
    start_date: datetime
    end_date: datetime
    options_data: Dict[str, List[HistoricalOptionData]]
    underlying_data: List[UnderlyingPriceData]
    coverage_stats: Optional[CoverageStats]
```

### 使用示例

```python
# 加载回测数据
dataset = manager.get_data_for_backtest(
    start_date=datetime(2024, 3, 1),
    end_date=datetime(2024, 3, 31),
    underlying_symbol="BTC"
)

# 访问数据
print(f"数据范围: {dataset.start_date} 至 {dataset.end_date}")
print(f"期权合约数: {len(dataset.options_data)}")
print(f"覆盖率: {dataset.coverage_stats.coverage_percentage:.1%}")

# 获取特定期权的数据
option_data = dataset.get_option_data("BTC-29MAR24-50000-C")
print(f"数据点数: {len(option_data)}")

# 遍历所有数据
for instrument_name in dataset.get_all_instruments():
    data_list = dataset.get_option_data(instrument_name)
    print(f"{instrument_name}: {len(data_list)} 条记录")
```

---

## 9. 数据来源

### CryptoDataDownload 格式

来自 https://www.cryptodatadownload.com/

**特点**：
- ✅ 免费获取
- ✅ 小时级数据
- ✅ OHLCV格式
- ⚠️ 需要手动下载
- ⚠️ 更新不及时

### Deribit API 格式

来自 Deribit 交易所 API

**特点**：
- ✅ 实时数据
- ✅ 分钟级精度
- ✅ 包含希腊字母
- ✅ 自动更新
- ⚠️ 需要API密钥
- ⚠️ 有请求限制

**API响应示例**：
```json
{
  "result": {
    "instrument_name": "BTC-29MAR24-50000-C",
    "mark_price": 0.0450,
    "bid_price": 0.0445,
    "ask_price": 0.0455,
    "last_price": 0.0450,
    "volume": 500,
    "open_interest": 1200,
    "greeks": {
      "delta": 0.52,
      "gamma": 0.00015,
      "theta": -0.008,
      "vega": 0.12,
      "rho": 0.05
    },
    "implied_volatility": 0.75,
    "timestamp": 1711670400000
  }
}
```

---

## 10. 数据使用场景

### 场景1: 回测跨式策略

```python
# 获取平值期权数据
call_data = dataset.get_option_data("BTC-29MAR24-50000-C")
put_data = dataset.get_option_data("BTC-29MAR24-50000-P")

# 计算策略成本
entry_cost = call_data[0].close_price + put_data[0].close_price
print(f"建仓成本: {entry_cost} BTC")

# 计算到期盈亏
exit_value = call_data[-1].close_price + put_data[-1].close_price
pnl = exit_value - entry_cost
print(f"盈亏: {pnl} BTC")
```

### 场景2: 波动率分析

```python
# 分析隐含波动率变化
for data in option_data:
    # 从价格反推隐含波动率
    iv = calculate_implied_volatility(
        option_price=data.close_price,
        underlying_price=50000,
        strike=data.strike_price,
        time_to_expiry=calculate_tte(data.timestamp, data.expiry_date)
    )
    print(f"{data.timestamp}: IV = {iv:.2%}")
```

### 场景3: 价格异常检测

```python
# 检测价格跳跃
for i in range(1, len(option_data)):
    prev_price = option_data[i-1].close_price
    curr_price = option_data[i].close_price
    
    change_pct = abs(curr_price - prev_price) / prev_price
    
    if change_pct > 0.20:  # 20%以上变化
        print(f"异常价格跳跃: {prev_price} -> {curr_price}")
```

---

## 总结

历史期权数据包含：

1. **基础信息**: 合约名称、执行价、到期日、期权类型
2. **价格数据**: OHLCV（开高低收量）
3. **时间信息**: Unix时间戳、日期时间
4. **元数据**: 数据来源、质量指标、覆盖率

**数据格式**：
- CSV文件（原始数据）
- SQLite数据库（存储）
- Python对象（处理）
- JSON（API传输）

**主要用途**：
- 策略回测
- 波动率分析
- 价格预测
- 风险评估
