# BTC期权交易系统 - 完整使用指南

## 📋 目录

1. [系统概述](#系统概述)
2. [数据来源说明](#数据来源说明)
3. [快速开始](#快速开始)
4. [配置真实数据](#配置真实数据)
5. [回测使用方法](#回测使用方法)
6. [常见问题](#常见问题)

---

## 系统概述

这是一个专业的BTC期权交易回测系统，支持：

- ✅ 多种期权策略（Long Call, Straddle, Iron Condor等）
- ✅ 完整的期权定价（Black-Scholes, 二叉树, 蒙特卡洛）
- ✅ 希腊字母计算（Delta, Gamma, Theta, Vega, Rho）
- ✅ 波动率分析（历史波动率, 隐含波动率, 波动率曲面）
- ✅ 风险管理（VaR, 压力测试, 保证金计算）
- ✅ 历史回测和绩效分析

---

## 数据来源说明

### 当前状态：使用模拟数据 ⚠️

**为什么使用模拟数据？**

系统目前使用基于Black-Scholes模型的模拟数据，原因是：

1. **API密钥未配置** - 需要Deribit API密钥才能获取真实数据
2. **开箱即用** - 无需配置即可体验系统功能
3. **学习友好** - 模拟数据符合期权定价理论，适合学习

**模拟数据特点：**

✅ **优点**：
- 基于Black-Scholes理论模型
- 包含波动率微笑特征
- 希腊字母计算准确
- 无需API配置即可使用

⚠️ **限制**：
- 不反映真实市场情况
- 标的价格固定不变
- 回测结果仅供学习参考
- **不能用于实盘交易决策**

### 如何切换到真实数据？

只需3步：

1. **获取Deribit API密钥**（5分钟）
2. **在系统中配置**（1分钟）
3. **重启后端服务**（1分钟）

详细步骤见下文 [配置真实数据](#配置真实数据)

---

## 快速开始

### 1. 启动系统

**启动后端API**：
```bash
cd BTCOptionsTrading/backend
python run_api.py
```

**启动前端界面**：
```bash
cd BTCOptionsTrading/frontend
npm run dev
```

**访问系统**：
- 前端: http://localhost:3000
- API文档: http://localhost:8000/docs

### 2. 浏览功能

#### 策略管理 Tab
- 查看可用策略模板
- 创建自定义策略
- 管理策略参数

#### 回测分析 Tab
- 选择策略
- 设置回测参数
- 查看盈亏曲线
- 分析绩效指标

#### 期权链 Tab
- 查看期权价格
- 查看希腊字母
- 分析隐含波动率

#### 波动率 Tab
- 波动率微笑
- 期限结构
- 历史vs隐含波动率

#### 设置 Tab
- 配置API密钥
- 设置交易参数
- 查看系统状态

---

## 配置真实数据

### 步骤1: 获取Deribit API密钥

#### 选项A: 测试网（推荐新手）

1. 访问 https://test.deribit.com
2. 注册账号（免费）
3. 登录后进入 **Account → API**
4. 点击 **"Create new key"**
5. 设置权限：
   - ✅ **Read** - 读取市场数据
   - ❌ **Trade** - 不需要
   - ❌ **Withdraw** - 不需要
6. 保存API Key和Secret

**测试网特点**：
- 🟡 使用虚拟资金
- 🟡 数据真实但可能有延迟
- 🟡 适合开发和测试
- 🟡 完全免费

#### 选项B: 主网（实盘交易）

1. 访问 https://www.deribit.com
2. 注册并完成KYC
3. 充值真实资金
4. 创建API密钥（同上）

**主网特点**：
- 🟢 真实市场数据
- 🟢 实时更新
- 🔴 使用真实资金
- 🔴 需要谨慎操作

### 步骤2: 在系统中配置

1. 打开前端: http://localhost:3000
2. 点击顶部的 **"设置"** Tab
3. 在 **"Deribit API配置"** 区域：

```
┌─────────────────────────────────────┐
│ 网络环境                            │
│ 🟡 测试网络  [●    ]               │
│    test.deribit.com (虚拟资金)     │
│                                     │
│ API Key                             │
│ [输入你的API Key]                   │
│                                     │
│ API Secret                          │
│ [输入你的API Secret]                │
│                                     │
│ [    保存配置    ]                  │
└─────────────────────────────────────┘
```

4. 选择网络模式：
   - 🟡 **测试网络** - 推荐新手
   - 🟢 **主网络** - 需要确认警告

5. 输入API Key和Secret

6. 点击 **"保存配置"**

7. 看到 ✅ **"Deribit配置保存成功"** 提示

### 步骤3: 重启后端服务

```bash
# 在后端终端按 Ctrl+C 停止服务
# 然后重新启动
cd BTCOptionsTrading/backend
python run_api.py
```

### 步骤4: 验证真实数据

1. 运行测试脚本：
```bash
cd BTCOptionsTrading/backend
python test_real_data.py
```

2. 预期输出：
```
============================================================
测试Deribit真实数据获取
============================================================

1. 检查API配置...
   Base URL: https://test.deribit.com
   Test Mode: True
   API Key: test_api_k...
   ✓ API密钥已配置

2. 创建Deribit连接器...
   ✓ 连接器创建成功

3. 获取BTC指数价格...
   ✓ BTC价格: $45,234.50

4. 获取BTC期权链...
   ✓ 获取到 156 个期权合约
   
   示例期权合约:
   - 合约名称: BTC-29DEC23-45000-C
   - 执行价: $45,000
   - 类型: call
   - 标记价格: $1,234.5678
   - 隐含波动率: 65.3%
   - Delta: 0.5234
   - Gamma: 0.0012
   - Vega: 123.45

5. 获取波动率曲面...
   ✓ 波动率曲面数据获取成功

============================================================
✓ 真实数据测试完成！
============================================================
```

3. 在前端查看：
   - 进入 **"期权链"** Tab
   - 点击 **"刷新数据"**
   - 应该看到真实的Deribit期权数据

---

## 回测使用方法

### 方法1: 通过Web界面（推荐）

#### 第1步: 创建策略

1. 进入 **"策略管理"** Tab
2. 选择策略模板：
   - **Long Call** - 买入看涨期权
   - **Long Put** - 买入看跌期权
   - **Straddle** - 跨式策略
   - **Strangle** - 宽跨式策略
   - **Iron Condor** - 铁鹰策略
   - **Butterfly** - 蝶式策略

3. 设置策略参数：
   ```
   策略名称: 我的第一个策略
   标的资产: BTC
   执行价: 45000
   到期日: 2024-03-29
   数量: 1
   ```

4. 点击 **"创建策略"**

#### 第2步: 运行回测

1. 进入 **"回测分析"** Tab

2. 选择策略：
   ```
   策略: 我的第一个策略
   ```

3. 设置回测参数：
   ```
   开始日期: 2024-01-01
   结束日期: 2024-02-01
   初始资金: $100,000
   ```

4. 点击 **"运行回测"**

5. 等待计算完成（通常几秒钟）

#### 第3步: 查看结果

**盈亏曲线图**：
- 蓝线：组合价值
- 绿线：累计盈亏

**绩效指标**：
```
总收益率: +15.3%
夏普比率: 1.85
最大回撤: -8.2%
胜率: 65.0%
交易次数: 12
```

**交易明细**：
- 查看每笔交易的详情
- 盈亏分析
- 持仓时间

### 方法2: 通过Python脚本

创建文件 `my_backtest.py`：

```python
import asyncio
from datetime import datetime, timedelta
from decimal import Decimal
from src.backtest.backtest_engine import BacktestEngine
from src.strategy.strategy_manager import StrategyManager

async def run_my_backtest():
    # 创建引擎
    engine = BacktestEngine()
    strategy_manager = StrategyManager()
    
    # 创建Long Call策略
    strategy = strategy_manager.create_long_call_strategy(
        underlying_symbol="BTC",
        strike_price=Decimal("45000"),
        expiration_date=datetime.now() + timedelta(days=30),
        quantity=1
    )
    
    # 运行回测
    result = await engine.run_backtest(
        strategy=strategy,
        start_date=datetime(2024, 1, 1),
        end_date=datetime(2024, 2, 1),
        initial_capital=Decimal("100000")
    )
    
    # 打印结果
    print(f"策略名称: {result.strategy_name}")
    print(f"总收益率: {result.total_return:.2%}")
    print(f"夏普比率: {result.sharpe_ratio:.2f}")
    print(f"最大回撤: {result.max_drawdown:.2%}")
    print(f"胜率: {result.win_rate:.2%}")
    print(f"交易次数: {result.total_trades}")
    
    # 查看每日盈亏
    print("\n每日盈亏:")
    for pnl in result.daily_pnl[:5]:  # 显示前5天
        print(f"{pnl.date.date()}: ${pnl.portfolio_value:,.2f} (盈亏: ${pnl.daily_pnl:,.2f})")

if __name__ == "__main__":
    asyncio.run(run_my_backtest())
```

运行：
```bash
cd BTCOptionsTrading/backend
python my_backtest.py
```

---

## 常见问题

### Q1: 期权价格看起来不对？

**A**: 当前使用模拟数据。要使用真实数据：

1. 配置Deribit API密钥（见上文）
2. 重启后端服务
3. 刷新期权链数据

**如何判断是否使用真实数据**：
- 真实数据：价格会实时变化，有买卖价差
- 模拟数据：价格固定，基于理论模型

### Q2: 回测结果可靠吗？

**A**: 取决于数据来源：

**使用模拟数据**（当前默认）：
- ⚠️ 结果仅供学习参考
- ⚠️ 不反映真实市场情况
- ⚠️ 不能用于实盘决策

**使用真实数据**（配置API后）：
- ✅ 期权价格来自真实市场
- ⚠️ 但回测引擎还需改进：
  - 标的价格目前固定
  - 需要集成历史价格数据
  - 需要考虑滑点和流动性

**建议**：
1. 先用模拟数据学习系统
2. 配置API获取真实期权数据
3. 等待回测引擎改进后再用于决策

### Q3: 如何获取历史数据进行回测？

**A**: 当前回测使用简化模型。要使用真实历史数据：

**短期方案**（需要开发）：
```python
# 修改回测引擎，集成Deribit历史数据
historical_prices = await connector.get_historical_data(
    instrument="BTC-PERPETUAL",
    start_timestamp=start_date,
    end_timestamp=end_date,
    resolution="1D"
)
```

**长期方案**：
1. 下载并缓存历史数据
2. 存储到本地数据库
3. 支持离线回测

### Q4: 测试网和主网有什么区别？

**A**:

| 特性 | 测试网 | 主网 |
|------|--------|------|
| 资金 | 🟡 虚拟资金 | 🟢 真实资金 |
| 数据 | 🟡 真实但可能有延迟 | 🟢 完全真实 |
| 费用 | 🟡 免费 | 🔴 真实交易费用 |
| 风险 | 🟡 无风险 | 🔴 真实风险 |
| 用途 | 🟡 学习和测试 | 🟢 实盘交易 |

**建议**：
- 新手：使用测试网
- 有经验：测试网充分测试后再用主网

### Q5: 为什么需要API密钥？

**A**: API密钥用于：

1. **获取真实市场数据**
   - 期权价格
   - 隐含波动率
   - 成交量和持仓量

2. **访问历史数据**
   - 历史价格
   - 历史波动率
   - 用于回测

3. **实时数据推送**（未来功能）
   - WebSocket实时价格
   - 实时组合监控

**安全性**：
- ✅ 只需要Read权限
- ✅ 不需要Trade权限
- ✅ API密钥存储在本地.env文件
- ✅ 不会上传到服务器

### Q6: 模拟数据是如何生成的？

**A**: 使用Black-Scholes模型：

```
Call价格 = S * N(d1) - K * e^(-rT) * N(d2)
Put价格 = K * e^(-rT) * N(-d2) - S * N(-d1)

其中:
- S = 标的价格（BTC: $45,000）
- K = 执行价
- T = 到期时间（年）
- r = 无风险利率（5%）
- σ = 隐含波动率（80% + 波动率微笑）
```

**特点**：
- ✅ 符合期权定价理论
- ✅ 包含波动率微笑
- ✅ 希腊字母准确
- ⚠️ 不反映真实市场

### Q7: 如何验证系统是否使用真实数据？

**A**: 运行测试脚本：

```bash
cd BTCOptionsTrading/backend
python test_real_data.py
```

**成功标志**：
- ✅ 显示真实BTC价格
- ✅ 获取到期权合约列表
- ✅ 显示真实的隐含波动率

**失败标志**：
- ❌ "API密钥未配置"
- ❌ "连接失败"
- ❌ "认证失败"

### Q8: 系统支持哪些期权策略？

**A**: 当前支持6种策略：

1. **Long Call** - 买入看涨
   - 看涨市场
   - 有限风险，无限收益

2. **Long Put** - 买入看跌
   - 看跌市场
   - 有限风险，高收益潜力

3. **Straddle** - 跨式
   - 预期大幅波动
   - 方向不确定

4. **Strangle** - 宽跨式
   - 预期较大波动
   - 成本比Straddle低

5. **Iron Condor** - 铁鹰
   - 预期区间震荡
   - 收取权利金

6. **Butterfly** - 蝶式
   - 预期价格停留在中间
   - 有限风险和收益

---

## 下一步

### 立即可做

1. ✅ 浏览系统各个Tab（5分钟）
2. ✅ 创建一个简单策略（5分钟）
3. ✅ 运行模拟回测（1分钟）
4. ✅ 查看绩效指标（2分钟）

### 推荐操作

1. ✅ 获取Deribit测试网API密钥（5分钟）
2. ✅ 配置API并重启服务（2分钟）
3. ✅ 验证真实数据获取（1分钟）
4. ✅ 查看真实期权链（1分钟）

### 进阶学习

1. 📚 学习期权定价理论
2. 📚 理解希腊字母含义
3. 📚 研究波动率策略
4. 📚 分析历史回测结果

---

## 相关文档

- [数据来源详细说明](./DATA_SOURCE_GUIDE.md)
- [API配置指南](./API_CONFIGURATION_GUIDE.md)
- [网络切换指南](./NETWORK_TOGGLE_SUMMARY.md)
- [系统架构文档](./SYSTEM_SUMMARY.md)
- [Deribit API文档](https://docs.deribit.com/)

---

## 技术支持

如有问题，请查看：
1. 📖 本文档的常见问题部分
2. 📖 相关文档链接
3. 📖 系统日志文件

---

**祝你使用愉快！** 🚀
