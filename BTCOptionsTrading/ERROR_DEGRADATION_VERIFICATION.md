# 错误降级功能验证指南

## 如何验证任务 7.3 的实现

本指南帮助您验证错误降级功能是否正确实现。

## 前置条件

1. 启动后端服务器：
   ```bash
   cd BTCOptionsTrading/backend
   python run_api.py
   ```

2. 启动前端开发服务器：
   ```bash
   cd BTCOptionsTrading/frontend
   npm run dev
   ```

## 验证步骤

### 测试 1: 正常情况（API可用）

**目的**: 验证在API正常工作时，系统使用实时数据

**步骤**:
1. 打开浏览器访问 `http://localhost:5173`
2. 导航到"策略管理"标签页
3. 点击"创建新策略"按钮
4. 在向导中选择任意策略模板（如"跨式策略"）
5. 点击"下一步"进入参数配置
6. 选择一个到期日

**预期结果**:
- ✅ 不应该看到任何错误消息
- ✅ 执行价选择器应该显示实时的期权数据
- ✅ 市场数据区域不应该显示"模拟数据"标识
- ✅ 期权价格和隐含波动率应该是真实的市场数据

### 测试 2: API失败情况

**目的**: 验证当API失败时，系统正确降级

**步骤**:
1. 停止后端服务器（模拟API不可用）
2. 在前端，尝试创建新策略
3. 选择策略模板并进入参数配置
4. 选择一个到期日

**预期结果**:
- ✅ 应该看到黄色警告框，显示错误消息
- ✅ 错误消息应该是："无法加载实时市场数据，使用模拟数据"
- ✅ 错误消息下方应该有指引文字："您可以使用模拟数据继续创建策略，或点击'手动输入'按钮直接输入执行价。"
- ✅ 执行价选择器应该显示模拟数据
- ✅ 市场数据区域应该显示"模拟数据"标识（黄色警告图标 + "模拟数据"文字）
- ✅ 用户仍然可以选择执行价并继续创建策略

### 测试 3: 手动输入模式

**目的**: 验证用户可以切换到手动输入模式

**步骤**:
1. 在参数配置页面（无论API是否可用）
2. 找到执行价字段右上角的"手动输入"按钮
3. 点击"手动输入"按钮

**预期结果**:
- ✅ 执行价选择器应该被替换为数字输入框
- ✅ 输入框应该有占位符文字："输入执行价，例如: 45000"
- ✅ 按钮文字应该变为"使用选择器"
- ✅ 用户可以直接输入任意数字作为执行价
- ✅ 再次点击按钮应该切换回选择器模式

### 测试 4: 模拟数据指示器

**目的**: 验证模拟数据标识正确显示

**步骤**:
1. 在API失败的情况下（或后端返回空数据）
2. 选择一个执行价
3. 查看市场数据显示区域

**预期结果**:
- ✅ 市场数据区域的标题栏右侧应该显示黄色的"模拟数据"标识
- ✅ 标识应该包含警告图标和"模拟数据"文字
- ✅ 期权价格和IV数据应该显示（即使是模拟的）
- ✅ 用户可以看到这是模拟数据，而不是真实市场数据

### 测试 5: StrikePicker 无数据状态

**目的**: 验证StrikePicker在没有数据时的行为

**步骤**:
1. 在API失败且模拟数据生成失败的情况下（可以通过修改代码临时禁用模拟数据生成来测试）
2. 尝试点击执行价选择器

**预期结果**:
- ✅ 选择器按钮应该显示"无可用期权数据"
- ✅ 按钮应该是禁用状态（灰色，不可点击）
- ✅ 用户应该被引导使用"手动输入"按钮

### 测试 6: 多腿策略的错误处理

**目的**: 验证所有策略类型都有正确的错误处理

**步骤**:
1. 在API失败的情况下
2. 依次测试以下策略类型：
   - 单腿策略 (single_leg)
   - 跨式策略 (straddle)
   - 宽跨式策略 (strangle)
   - 铁鹰策略 (iron_condor)
   - 蝶式策略 (butterfly)

**预期结果**:
- ✅ 所有策略类型都应该显示相同的错误消息
- ✅ 所有执行价字段都应该有"手动输入"切换按钮
- ✅ 所有策略类型都应该能够使用模拟数据或手动输入完成创建

## 视觉检查清单

### 错误消息样式
- [ ] 黄色背景（`bg-yellow-900 bg-opacity-20`）
- [ ] 黄色边框（`border-yellow-600`）
- [ ] 警告图标（三角形感叹号）
- [ ] 清晰的错误文字
- [ ] 有用的指引文字

### 模拟数据指示器样式
- [ ] 黄色文字（`text-yellow-500`）
- [ ] 小型警告图标
- [ ] "模拟数据"文字
- [ ] 位于市场数据区域的右上角

### 手动输入按钮样式
- [ ] 蓝色文字（`text-accent-blue`）
- [ ] 悬停时颜色变化
- [ ] 位于执行价标签的右侧
- [ ] 文字根据状态切换（"手动输入" / "使用选择器"）

## 功能完整性检查

- [ ] API失败时显示错误消息
- [ ] 自动降级到模拟数据
- [ ] 模拟数据标识正确显示
- [ ] 手动输入切换功能正常
- [ ] 手动输入模式下可以输入任意执行价
- [ ] 可以在选择器和手动输入之间自由切换
- [ ] 所有策略类型都支持错误降级
- [ ] 用户可以在API失败的情况下完成策略创建

## 边界情况测试

### 边界情况 1: 网络间歇性故障
**场景**: API有时成功，有时失败

**测试**:
1. 创建策略时API成功
2. 修改到期日时API失败
3. 再次修改到期日时API恢复

**预期**: 系统应该能够正确处理状态切换，错误消息应该在API恢复后消失

### 边界情况 2: 部分数据可用
**场景**: API返回数据但某些执行价缺失

**测试**:
1. 后端返回不完整的期权链数据
2. 某些执行价只有call没有put，或反之

**预期**: 系统应该过滤掉不完整的数据，只显示完整的期权对

### 边界情况 3: 极端市场条件
**场景**: 标的价格极高或极低

**测试**:
1. 设置标的价格为极端值（如100000或10000）
2. 触发模拟数据生成

**预期**: 模拟数据应该基于实际标的价格生成合理的执行价范围

## 性能检查

- [ ] 错误消息应该立即显示（不超过1秒）
- [ ] 模拟数据生成应该快速（不超过100ms）
- [ ] 手动输入切换应该即时响应
- [ ] 不应该有明显的UI卡顿或延迟

## 可访问性检查

- [ ] 错误消息应该有足够的颜色对比度
- [ ] 警告图标应该有适当的大小
- [ ] 手动输入按钮应该有清晰的点击区域
- [ ] 键盘导航应该正常工作

## 问题排查

### 如果错误消息没有显示
1. 检查浏览器控制台是否有JavaScript错误
2. 确认`optionsLoadError`状态正确设置
3. 检查条件渲染逻辑

### 如果模拟数据没有生成
1. 检查`generateMockOptionsData`函数是否被调用
2. 确认`underlyingPrice`有有效值
3. 检查`setOptionsData`是否正确更新状态

### 如果手动输入不工作
1. 检查`useManualInput`状态
2. 确认切换按钮的onClick事件正确绑定
3. 检查条件渲染逻辑（`useManualInput ? ... : ...`）

## 总结

完成以上所有测试后，您应该能够确认：

✅ 错误降级功能完全实现
✅ 用户体验流畅且直观
✅ 系统在API失败时仍然可用
✅ 所有策略类型都得到支持
✅ 符合需求 3.4 的所有要求

如果发现任何问题，请参考`ERROR_DEGRADATION_IMPLEMENTATION.md`文档了解实现细节。
