# 实现计划: 策略管理页面增强

## 概述

本实现计划将策略管理页面增强功能分为4个阶段，每个阶段包含多个可执行的任务。任务按照依赖关系排序，确保每个任务都可以基于前面的任务进行构建。

## 任务

### 阶段 1: 核心功能增强

- [ ] 1. 后端API增强 - 策略更新和验证
  - [x] 1.1 实现策略更新API接口
    - 在`src/api/routes/strategies.py`中添加`PUT /{strategy_id}`端点
    - 实现`StrategyUpdateRequest`模型
    - 更新`StrategyDAO`添加`update`方法
    - _需求: 1.3_
  
  - [x] 1.2 编写策略更新API的单元测试
    - 测试成功更新场景
    - 测试部分字段更新
    - 测试不存在的策略ID
    - _需求: 1.3_
  
  - [ ] 1.3 编写策略更新一致性的属性测试
    - **属性 1: 策略更新保持一致性**
    - **验证: 需求 1.3**
  
  - [x] 1.4 实现策略验证API接口
    - 在`src/api/routes/strategies.py`中添加`POST /validate`端点
    - 创建`StrategyValidator`类在`src/strategy/strategy_validator.py`
    - 实现参数合理性验证逻辑
    - _需求: 7.1, 7.3_
  
  - [ ] 1.5 编写参数验证的属性测试
    - **属性 10: 参数验证完整性**
    - **验证: 需求 7.1, 7.3**

- [ ] 2. 后端API增强 - 风险计算
  - [x] 2.1 实现策略风险计算API接口
    - 在`src/api/routes/strategies.py`中添加`POST /calculate-risk`端点
    - 扩展`RiskCalculator`类添加策略级别的风险计算
    - 实现盈亏平衡点计算
    - _需求: 7.4, 14.3_
  
  - [ ] 2.2 编写风险计算准确性的属性测试
    - **属性 4: 风险计算准确性**
    - **验证: 需求 7.4, 14.3**

- [ ] 3. 后端API增强 - 期权链数据
  - [x] 3.1 修复Deribit连接器的期权链接口
    - 修改`DeribitConnector.get_options_chain`方法签名，移除`kind`参数
    - 更新`src/api/routes/data.py`中的调用
    - _需求: 3.1_
  
  - [x] 3.2 实现增强的期权链API接口
    - 在`src/api/routes/data.py`中添加`GET /options-chain-enhanced`端点
    - 按到期日分组期权数据
    - 添加标的价格和到期天数信息
    - _需求: 3.1, 4.2_
  
  - [ ] 3.3 编写期权链数据完整性的属性测试
    - **属性 3: 期权链数据完整性**
    - **验证: 需求 3.1, 4.2, 4.5**
  
  - [x] 3.4 实现市场数据缓存
    - 创建`MarketDataCache`类在`src/connectors/market_data_cache.py`
    - 使用内存缓存（字典）存储期权链数据
    - 设置5分钟TTL
    - _需求: 非功能需求 - 可靠性 3_

- [ ] 4. 前端 - 策略详情模态框
  - [x] 4.1 创建StrategyDetailModal组件
    - 创建`frontend/src/components/strategy/StrategyDetailModal.tsx`
    - 实现基本布局和样式
    - 显示策略基本信息
    - _需求: 2.1, 2.2_
  
  - [x] 4.2 添加策略腿详情显示
    - 在详情模态框中添加策略腿列表
    - 显示每个腿的合约信息、买卖方向、数量
    - _需求: 2.3_
  
  - [x] 4.3 添加风险指标显示
    - 在详情模态框中添加风险指标区域
    - 显示最大收益、最大损失、盈亏平衡点
    - 显示希腊字母汇总
    - _需求: 2.4, 14.1, 14.2, 14.3, 14.4, 14.5_
  
  - [x] 4.4 添加操作按钮
    - 添加"编辑"、"删除"、"复制"按钮
    - 实现按钮点击事件处理
    - _需求: 2.5_
  
  - [x] 4.5 集成详情模态框到策略列表
    - 修改`StrategiesTab.tsx`，添加详情模态框状态
    - 在`StrategyCard`点击时打开详情模态框
    - _需求: 1.1, 2.1_

- [ ] 5. 前端 - 策略编辑功能
  - [x] 5.1 创建StrategyEditModal组件
    - 创建`frontend/src/components/strategy/StrategyEditModal.tsx`
    - 复用策略创建表单的布局
    - 实现表单预填充逻辑
    - _需求: 1.2_
  
  - [x] 5.2 实现策略更新API调用
    - 在`frontend/src/api/strategies.ts`中添加`update`方法
    - 在编辑模态框中调用更新API
    - 处理成功和错误情况
    - _需求: 1.3, 1.4_
  
  - [x] 5.3 集成编辑功能到详情模态框
    - 在详情模态框的"编辑"按钮点击时打开编辑模态框
    - 传递当前策略数据
    - _需求: 1.2_

- [ ] 6. 前端 - 智能执行价选择器
  - [x] 6.1 创建StrikePicker组件
    - 创建`frontend/src/components/strategy/StrikePicker.tsx`
    - 实现下拉菜单UI
    - 显示所有可用执行价
    - _需求: 4.1, 4.2_
  
  - [x] 6.2 添加期权数据显示
    - 在每个执行价选项中显示看涨和看跌价格
    - 显示隐含波动率
    - _需求: 4.5_
  
  - [x] 6.3 实现ATM高亮
    - 计算最接近标的价格的执行价
    - 添加高亮样式
    - _需求: 4.3_
  
  - [ ] 6.4 编写ATM识别准确性的属性测试
    - **属性 11: ATM识别准确性**
    - **验证: 需求 4.3, 13.2**
  
  - [x] 6.5 集成StrikePicker到策略创建表单
    - 替换手动输入框为StrikePicker
    - 处理选择回调，更新表单数据
    - _需求: 4.4_

- [ ] 7. 前端 - 实时市场数据集成
  - [x] 7.1 加载期权链数据
    - 在策略创建/编辑表单中添加期权链加载逻辑
    - 当用户选择到期日时触发加载
    - 显示加载状态
    - _需求: 3.1_
  
  - [x] 7.2 显示选中期权的市场数据
    - 在表单中添加市场数据显示区域
    - 显示当前价格、IV、标的价格
    - 已集成到所有策略类型的表单中
    - _需求: 3.2, 3.3_
  
  - [x] 7.3 实现错误降级
    - 当API失败时显示错误消息
    - 允许用户手动输入价格
    - _需求: 3.4_

- [x] 8. Checkpoint - 核心功能验证
  - 确保所有测试通过
  - 手动测试策略编辑、详情查看、执行价选择功能
  - 验证与实时数据的集成
  - 询问用户是否有问题

### 阶段 2: 用户体验优化

- [x] 9. 前端 - 策略创建向导
  - [x] 9.1 创建StrategyWizard组件框架
    - 创建`frontend/src/components/strategy/StrategyWizard.tsx`
    - 实现3步导航UI（步骤指示器）
    - 管理当前步骤状态
    - _需求: 5.1, 5.2_
  
  - [x] 9.2 实现步骤1 - 模板选择
    - 创建`Step1_TemplateSelection.tsx`
    - 显示所有策略模板卡片
    - 处理模板选择
    - _需求: 5.1_
  
  - [x] 9.3 实现步骤2 - 参数配置
    - 创建`Step2_ParameterConfig.tsx`
    - 根据选中的模板显示相应的表单字段
    - 集成StrikePicker和期权链数据
    - _需求: 5.1_
  
  - [x] 9.4 实现步骤3 - 确认创建
    - 创建`Step3_Confirmation.tsx`
    - 显示策略摘要和风险指标
    - 实现最终提交
    - _需求: 5.1_
  
  - [x] 9.5 添加步骤验证
    - 在每个步骤实现验证逻辑
    - 只有验证通过才能进入下一步
    - _需求: 5.3_
  
  - [x] 9.6 编写向导步骤验证的单元测试
    - 测试每个步骤的验证逻辑
    - 测试步骤导航
    - _需求: 5.3_
  
  - [x] 9.7 添加帮助提示
    - 在每个输入字段旁添加帮助图标
    - 实现提示弹出框
    - _需求: 5.4, 5.5_
  
  - [x] 9.8 替换现有创建表单为向导
    - 在`StrategiesTab.tsx`中使用StrategyWizard替代原有模态框
    - 保持向后兼容
    - _需求: 5.1_

- [x] 10. 前端 - 策略模板增强
  - [x] 10.1 扩展策略模板数据
    - 在后端`/templates/list`接口中添加详细描述、适用场景、风险特征
    - 更新`StrategyTemplate`类型定义
    - _需求: 6.1_
  
  - [x] 10.2 增强模板卡片显示
    - 在模板卡片中显示详细信息
    - 添加悬停效果显示关键特点
    - _需求: 6.1, 6.3_
  
  - [x] 10.3 添加收益曲线图示
    - 为每个模板添加简化的收益曲线SVG图
    - 在模板卡片中显示
    - _需求: 6.2_
  
  - [x] 10.4 添加"了解更多"链接
    - 链接到详细文档或帮助页面
    - _需求: 6.4_

- [ ] 11. 后端 - 策略验证和风险提示
  - [x] 11.1 实现实时参数验证
    - 在`StrategyValidator`中添加实时验证方法
    - 返回错误和警告列表
    - _需求: 7.1_
  
  - [x] 11.2 实现风险阈值检查
    - 检查最大损失是否超过初始资金的50%
    - 返回高风险警告
    - _需求: 7.2_
  
  - [x] 11.3 实现配置合理性检查
    - 检查宽跨式执行价顺序
    - 检查铁鹰策略执行价顺序
    - 检查数量和价格的合理性
    - _需求: 7.3_

- [x] 12. 前端 - 验证和风险提示UI
  - [x] 12.1 集成实时验证
    - 在策略创建/编辑表单中调用验证API
    - 显示验证错误和警告
    - _需求: 7.1_
  
  - [x] 12.2 显示风险指标预览
    - 在确认步骤显示最大收益、最大损失、盈亏比
    - 使用颜色标识风险等级
    - _需求: 7.4_
  
  - [x] 12.3 实现高风险二次确认
    - 当检测到高风险时显示确认对话框
    - 要求用户明确确认
    - _需求: 7.5_

- [x] 13. 前端 - 策略复制功能
  - [x] 13.1 在详情模态框添加复制按钮
    - 添加"复制"按钮到操作区域
    - _需求: 8.1_
  
  - [x] 13.2 实现复制逻辑
    - 点击复制时打开创建向导/表单
    - 预填充原策略的所有参数
    - 在名称后添加"(副本)"后缀
    - _需求: 8.1, 8.2_
  
  - [x] 13.3 编写策略复制完整性的属性测试
    - **属性 9: 策略复制完整性**
    - **验证: 需求 8.2, 8.3, 8.5**
  
  - [x] 13.4 显示复制关系
    - 在策略卡片中显示"基于XXX策略"
    - 在数据库中存储原策略ID（可选）
    - _需求: 8.4_

- [ ] 14. Checkpoint - 用户体验验证
  - 确保所有测试通过
  - 手动测试向导流程、模板选择、验证提示、复制功能
  - 询问用户是否有问题

### 阶段 3: 高级功能

- [x] 15. 前端 - 搜索和筛选
  - [ ] 15.1 添加搜索框
    - 在策略列表上方添加搜索输入框
    - _需求: 9.1_
  
  - [ ] 15.2 实现实时搜索
    - 监听搜索输入变化
    - 过滤策略列表（按名称和描述）
    - _需求: 9.2_
  
  - [ ] 15.3 编写搜索结果完整性的属性测试
    - **属性 8: 搜索结果完整性和准确性**
    - **验证: 需求 9.2**
  
  - [ ] 15.4 添加筛选下拉菜单
    - 添加按策略类型筛选的下拉菜单
    - 实现筛选逻辑
    - _需求: 9.3_
  
  - [ ] 15.5 添加排序功能
    - 添加排序选择器（创建时间、最大收益、最大损失）
    - 实现排序逻辑
    - _需求: 9.4, 9.5_
  
  - [ ] 15.6 编写排序功能正确性的属性测试
    - **属性 12: 排序功能正确性**
    - **验证: 需求 9.4, 9.5**

- [ ] 16. 前端 - 批量操作
  - [ ] 16.1 添加多选复选框
    - 在每个策略卡片添加复选框
    - 管理选中状态
    - _需求: 10.1_
  
  - [ ] 16.2 显示批量操作工具栏
    - 当有策略被选中时显示工具栏
    - 显示选中数量
    - _需求: 10.2_
  
  - [ ] 16.3 添加批量操作按钮
    - 添加"删除"和"导出"按钮
    - _需求: 10.3_

- [ ] 17. 后端 - 批量操作API
  - [ ] 17.1 实现批量删除API
    - 在`src/api/routes/strategies.py`中添加`POST /batch-delete`端点
    - 使用数据库事务确保原子性
    - _需求: 10.4_
  
  - [ ] 17.2 编写批量操作原子性的属性测试
    - **属性 6: 批量操作原子性**
    - **验证: 需求 10.4**
  
  - [ ] 17.3 实现批量导出API
    - 在`src/api/routes/strategies.py`中添加`POST /batch-export`端点
    - 返回JSON格式的策略数据
    - _需求: 10.5_

- [ ] 18. 前端 - 批量操作集成
  - [ ] 18.1 实现批量删除
    - 调用批量删除API
    - 显示确认对话框
    - 刷新列表
    - _需求: 10.4_
  
  - [ ] 18.2 实现批量导出
    - 调用批量导出API
    - 下载JSON文件
    - _需求: 10.5_

- [ ] 19. 后端 - 导入导出功能
  - [ ] 19.1 实现策略导出
    - 在策略详情API中添加导出格式化
    - 确保包含所有必要字段
    - _需求: 11.1_
  
  - [ ] 19.2 实现策略导入API
    - 在`src/api/routes/strategies.py`中添加`POST /import`端点
    - 验证JSON格式
    - 处理名称冲突
    - _需求: 11.3, 11.4_
  
  - [ ] 19.3 编写导入导出往返一致性的属性测试
    - **属性 7: 策略导入导出往返一致性**
    - **验证: 需求 11.1, 11.3**
  
  - [ ] 19.4 编写名称冲突处理的属性测试
    - **属性 13: 名称冲突处理**
    - **验证: 需求 11.4**

- [ ] 20. 前端 - 导入导出UI
  - [ ] 20.1 添加单个策略导出
    - 在详情模态框添加"导出"按钮
    - 下载JSON文件
    - _需求: 11.1_
  
  - [ ] 20.2 添加导入按钮
    - 在策略列表页面添加"导入策略"按钮
    - _需求: 11.2_
  
  - [ ] 20.3 实现导入流程
    - 文件选择器
    - 调用导入API
    - 显示导入结果
    - _需求: 11.3, 11.5_

- [ ] 21. WebSocket实时价格更新
  - [ ] 21.1 扩展WebSocket消息类型
    - 在后端添加策略市场价值推送
    - 计算每个策略的当前市场价值和未实现盈亏
    - _需求: 12.1, 12.2, 12.3_
  
  - [ ] 21.2 前端订阅价格更新
    - 在`StrategiesTab`中建立WebSocket连接
    - 监听策略价格更新消息
    - _需求: 12.3_
  
  - [ ] 21.3 更新策略卡片显示
    - 在策略卡片中显示市场价值和未实现盈亏
    - 使用颜色标识盈利/亏损
    - _需求: 12.1, 12.2, 12.4_
  
  - [ ] 21.4 编写实时价格更新及时性的属性测试
    - **属性 5: 实时价格更新及时性**
    - **验证: 需求 12.3, 12.1, 12.2**
  
  - [ ] 21.5 在详情模态框显示实时数据
    - 显示每个腿的当前市场价格和盈亏
    - _需求: 12.5_

- [ ] 22. Checkpoint - 高级功能验证
  - 确保所有测试通过
  - 手动测试搜索、筛选、批量操作、导入导出、实时更新
  - 询问用户是否有问题

### 阶段 4: 扩展功能

- [ ] 23. 前端 - 快速创建常用策略
  - [ ] 23.1 添加快速创建按钮
    - 在策略模板区域添加"快速创建"按钮
    - _需求: 13.1_
  
  - [ ] 23.2 实现ATM跨式快速创建
    - 自动选择最接近当前价格的执行价
    - 使用默认到期日
    - _需求: 13.2, 13.4_
  
  - [ ] 23.3 实现ATM宽跨式快速创建
    - 自动选择合理的看涨和看跌执行价
    - _需求: 13.3_
  
  - [ ] 23.4 显示确认对话框
    - 显示自动选择的参数
    - 允许用户调整
    - _需求: 13.5_

- [ ] 24. 前端 - 策略性能指标增强
  - [ ] 24.1 在详情模态框添加性能指标区域
    - 显示所有希腊字母汇总
    - 显示盈亏平衡点
    - 显示收益风险比
    - 显示初始成本
    - _需求: 14.1, 14.2, 14.3, 14.4, 14.5_
  
  - [ ] 24.2 编写策略详情显示完整性的属性测试
    - **属性 2: 策略详情显示完整性**
    - **验证: 需求 2.2, 2.3, 2.4, 14.1, 14.2, 14.3, 14.4, 14.5**

- [ ] 25. 前端 - 移动端响应式优化
  - [ ] 25.1 优化策略列表布局
    - 在小屏幕上使用单列布局
    - _需求: 15.2_
  
  - [ ] 25.2 优化表单输入
    - 使用移动端友好的输入控件
    - 优化触摸目标大小
    - _需求: 15.2_
  
  - [ ] 25.3 优化详情模态框
    - 使用全屏模态框
    - 使用折叠面板组织信息
    - _需求: 15.2_
  
  - [ ] 25.4 添加滑动手势删除
    - 在策略卡片上实现滑动删除
    - _需求: 15.5_

- [ ] 26. 最终Checkpoint - 完整功能验证
  - 运行所有测试套件
  - 进行完整的端到端测试
  - 测试移动端体验
  - 性能测试（加载时间、搜索响应）
  - 询问用户是否满意，是否需要调整

## 注意事项

- 所有任务都是必做的，包括单元测试和属性测试
- 每个阶段结束时都有checkpoint，确保功能正常后再继续
- 任务按照依赖关系排序，建议按顺序执行
- 每个任务都引用了相关的需求编号，便于追溯
- 属性测试任务明确标注了要验证的属性和需求
